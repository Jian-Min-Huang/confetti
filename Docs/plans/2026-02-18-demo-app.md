# Demo App Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a macOS native demo app with 7 panels, each displaying a different preset effect in an infinite loop.

**Architecture:** Standalone Swift Package in `Demo/` directory. AppKit window with manual layout of 7 `SKView` panels in a 4+3 grid. Each panel runs its own `ParticleScene` with looping support. Effect source files copied from main project with minimal modification.

**Tech Stack:** Swift 5.9, AppKit, SpriteKit, Swift Package Manager

---

### Task 1: Create Demo Package.swift

**Files:**
- Create: `Demo/Package.swift`

**Step 1: Create the package manifest**

```swift
// swift-tools-version: 5.9
import PackageDescription

let package = Package(
    name: "ConfettiDemo",
    platforms: [.macOS(.v13)],
    targets: [
        .executableTarget(
            name: "ConfettiDemo",
            path: "Sources"
        )
    ]
)
```

**Step 2: Verify package resolves**

Run: `cd Demo && swift package describe`
Expected: Package name "ConfettiDemo" with one target

---

### Task 2: Copy shared source files from main project

**Files:**
- Create: `Demo/Sources/Effects/ParticleEffect.swift` (copy from `Sources/Effects/ParticleEffect.swift`)
- Create: `Demo/Sources/Effects/ConfettiEffect.swift` (copy)
- Create: `Demo/Sources/Effects/FallingLeavesEffect.swift` (copy)
- Create: `Demo/Sources/Effects/FireworksEffect.swift` (copy)
- Create: `Demo/Sources/Effects/MeteorShowerEffect.swift` (copy)
- Create: `Demo/Sources/Effects/BubblesEffect.swift` (copy)
- Create: `Demo/Sources/Effects/SnowEffect.swift` (copy)
- Create: `Demo/Sources/EmojiTexture.swift` (copy)

**Step 1: Copy all effect files and EmojiTexture verbatim**

These files need zero modifications. Copy them exactly as-is from the main `Sources/` directory.

```bash
mkdir -p Demo/Sources/Effects
cp Sources/Effects/ParticleEffect.swift Demo/Sources/Effects/
cp Sources/Effects/ConfettiEffect.swift Demo/Sources/Effects/
cp Sources/Effects/FallingLeavesEffect.swift Demo/Sources/Effects/
cp Sources/Effects/FireworksEffect.swift Demo/Sources/Effects/
cp Sources/Effects/MeteorShowerEffect.swift Demo/Sources/Effects/
cp Sources/Effects/BubblesEffect.swift Demo/Sources/Effects/
cp Sources/Effects/SnowEffect.swift Demo/Sources/Effects/
cp Sources/EmojiTexture.swift Demo/Sources/
```

---

### Task 3: Create DemoConfig.swift

**Files:**
- Create: `Demo/Sources/DemoConfig.swift`

**Step 1: Write DemoConfig with preset definitions and shared types**

This file combines the Config struct, enums (EffectStyle, EasingType, Density), and a `DemoPreset` enum that defines all 7 panel configurations. No CLI parsing needed.

```swift
import Foundation
import CoreGraphics

// MARK: - Effect Style

enum EffectStyle: String {
    case confetti
    case fallingLeaves = "falling-leaves"
    case fireworks
    case meteorShower = "meteor-shower"
    case bubbles
    case snow
}

// MARK: - Easing Type

enum EasingType: String {
    case linear
    case easeIn = "ease-in"
    case easeOut = "ease-out"
    case easeInOut = "ease-in-out"

    func position(at progress: CGFloat, exponent n: CGFloat = 2.0) -> CGFloat {
        let t = min(max(progress, 0), 1)
        switch self {
        case .linear:    return t
        case .easeIn:    return pow(t, n)
        case .easeOut:   return 1.0 - pow(1.0 - t, n)
        case .easeInOut:
            if t < 0.5 { return pow(2.0, n - 1) * pow(t, n) }
            else { return 1.0 - pow(2.0, n - 1) * pow(1.0 - t, n) }
        }
    }

    func speedMultiplier(at progress: CGFloat, exponent n: CGFloat = 2.0) -> CGFloat {
        let t = min(max(progress, 0), 1)
        switch self {
        case .linear: return 1.0
        case .easeIn: return n * pow(t, n - 1)
        case .easeOut: return n * pow(1.0 - t, n - 1)
        case .easeInOut:
            let scale = n * pow(2.0, n - 1)
            if t < 0.5 { return scale * pow(t, n - 1) }
            else { return scale * pow(1.0 - t, n - 1) }
        }
    }
}

// MARK: - Density

enum Density: String {
    case low, medium, high

    var particleCount: Int {
        switch self {
        case .low:    return 100
        case .medium: return 200
        case .high:   return 300
        }
    }
}

// MARK: - Config

struct Config {
    var style: EffectStyle = .confetti
    var emojis: [String] = ["ðŸŽ‰", "ðŸŽŠ", "âœ¨"]
    var density: Density = .medium
    var speed: Double = 1.0
    var easing: EasingType = .easeOut
    var easingExponent: Double = 3.0
    var duration: Double = 5.0
}

// MARK: - Demo Presets

struct DemoPreset {
    let title: String
    let config: Config

    static let all: [DemoPreset] = [
        DemoPreset(title: "Confetti", config: {
            var c = Config(); c.style = .confetti; c.emojis = ["ðŸŽ‰", "ðŸŽ", "ðŸ¬"]
            c.density = .medium; c.speed = 5.0; c.easing = .linear; c.duration = 2.5; return c
        }()),
        DemoPreset(title: "Cherry", config: {
            var c = Config(); c.style = .fallingLeaves; c.emojis = ["ðŸŒ¸"]
            c.density = .low; c.speed = 1.5; c.easing = .linear; c.duration = 5.0; return c
        }()),
        DemoPreset(title: "Maple", config: {
            var c = Config(); c.style = .fallingLeaves; c.emojis = ["ðŸ‚", "ðŸ"]
            c.density = .low; c.speed = 1.5; c.easing = .linear; c.duration = 5.0; return c
        }()),
        DemoPreset(title: "Snow", config: {
            var c = Config(); c.style = .snow; c.emojis = ["â„ï¸", "â˜ƒï¸"]
            c.density = .high; c.speed = 2.5; c.easing = .linear; c.duration = 5.0; return c
        }()),
        DemoPreset(title: "Fireworks", config: {
            var c = Config(); c.style = .fireworks; c.emojis = ["â­", "ðŸŒŸ", "ðŸ’«", "ðŸ’¥", "âœ¨", "ðŸ”¸", "ðŸ”¹"]
            c.density = .high; c.speed = 1.0; c.easing = .easeOut; c.duration = 5.0; return c
        }()),
        DemoPreset(title: "Meteor", config: {
            var c = Config(); c.style = .meteorShower; c.emojis = ["â­"]
            c.density = .low; c.speed = 2.0; c.easing = .linear; c.duration = 5.0; return c
        }()),
        DemoPreset(title: "Bubbles", config: {
            var c = Config(); c.style = .bubbles; c.emojis = ["ðŸ«§"]
            c.density = .low; c.speed = 1.0; c.easing = .linear; c.duration = 5.0; return c
        }()),
    ]
}
```

---

### Task 4: Create ParticleScene with looping support

**Files:**
- Create: `Demo/Sources/ParticleScene.swift`

**Step 1: Write ParticleScene with auto-reset loop**

Modified from main project's `ParticleScene.swift`. Key change: when `elapsed > config.duration`, remove all children and re-setup the effect.

```swift
import SpriteKit

class ParticleScene: SKScene {

    private let config: Config
    private var effect: ParticleEffect?
    private var lastUpdateTime: TimeInterval = 0
    private var firstUpdate = true
    private var loopStartTime: TimeInterval = 0

    init(size: CGSize, config: Config) {
        self.config = config
        super.init(size: size)
        self.backgroundColor = NSColor(red: 0.1, green: 0.1, blue: 0.18, alpha: 1.0) // #1a1a2e
    }

    @available(*, unavailable)
    required init?(coder aDecoder: NSCoder) { fatalError() }

    override func didMove(to view: SKView) {
        resetEffect()
    }

    override func update(_ currentTime: TimeInterval) {
        if firstUpdate {
            lastUpdateTime = currentTime
            loopStartTime = currentTime
            firstUpdate = false
            return
        }
        let dt = currentTime - lastUpdateTime
        lastUpdateTime = currentTime
        let clampedDt = min(dt, 1.0 / 30.0)
        effect?.update(currentTime: currentTime, deltaTime: clampedDt)

        // Loop: reset after duration + 0.5s fade-out buffer
        let elapsed = currentTime - loopStartTime
        if elapsed > config.duration + 0.5 {
            loopStartTime = currentTime
            resetEffect()
        }
    }

    private func resetEffect() {
        removeAllChildren()
        effect = Self.createEffect(style: config.style, config: config, sceneSize: size)
        effect?.setup(in: self)
    }

    private static func createEffect(style: EffectStyle, config: Config, sceneSize: CGSize) -> ParticleEffect {
        switch style {
        case .confetti:      return ConfettiEffect(config: config, sceneSize: sceneSize)
        case .fireworks:     return FireworksEffect(config: config, sceneSize: sceneSize)
        case .fallingLeaves: return FallingLeavesEffect(config: config, sceneSize: sceneSize)
        case .meteorShower:  return MeteorShowerEffect(config: config, sceneSize: sceneSize)
        case .bubbles:       return BubblesEffect(config: config, sceneSize: sceneSize)
        case .snow:          return SnowEffect(config: config, sceneSize: sceneSize)
        }
    }
}
```

---

### Task 5: Create DemoAppDelegate with 7-panel grid layout

**Files:**
- Create: `Demo/Sources/DemoAppDelegate.swift`

**Step 1: Write DemoAppDelegate**

Creates a window with 7 panels in 4+3 grid. Each panel is an `NSView` containing an `SKView` and a title `NSTextField`. The bottom row of 3 is centered.

```swift
import AppKit
import SpriteKit

class DemoAppDelegate: NSObject, NSApplicationDelegate {

    private var window: NSWindow!

    func applicationDidFinishLaunching(_ notification: Notification) {
        let windowWidth: CGFloat = 1200
        let windowHeight: CGFloat = 800
        let windowRect = NSRect(x: 0, y: 0, width: windowWidth, height: windowHeight)

        window = NSWindow(
            contentRect: windowRect,
            styleMask: [.titled, .closable, .resizable, .miniaturizable],
            backing: .buffered,
            defer: false
        )
        window.title = "Confetti Demo"
        window.center()
        window.minSize = NSSize(width: 800, height: 540)

        let contentView = NSView(frame: windowRect)
        contentView.wantsLayer = true
        contentView.layer?.backgroundColor = NSColor(red: 0.08, green: 0.08, blue: 0.14, alpha: 1.0).cgColor
        window.contentView = contentView

        let presets = DemoPreset.all

        // Layout constants
        let padding: CGFloat = 12
        let titleHeight: CGFloat = 28
        let cols = 4

        // Use Auto Layout
        contentView.translatesAutoresizingMaskIntoConstraints = false

        // Create panels using manual frame layout in layoutSubviews override
        // Instead, use a container view that handles resize
        let container = DemoGridView(presets: presets, padding: padding, titleHeight: titleHeight, cols: cols)
        container.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(container)

        NSLayoutConstraint.activate([
            container.leadingAnchor.constraint(equalTo: contentView.leadingAnchor),
            container.trailingAnchor.constraint(equalTo: contentView.trailingAnchor),
            container.topAnchor.constraint(equalTo: contentView.topAnchor),
            container.bottomAnchor.constraint(equalTo: contentView.bottomAnchor),
        ])

        window.makeKeyAndOrderFront(nil)
        NSApp.activate(ignoringOtherApps: true)
    }

    func applicationShouldTerminateAfterLastWindowClosed(_ sender: NSApplication) -> Bool {
        return true
    }
}
```

---

### Task 6: Create DemoGridView for resizable panel layout

**Files:**
- Create: `Demo/Sources/DemoGridView.swift`

**Step 1: Write DemoGridView**

A custom `NSView` that manages 7 panel subviews in a 4+3 grid. Recalculates layout on resize.

```swift
import AppKit
import SpriteKit

class DemoGridView: NSView {

    private let presets: [DemoPreset]
    private let padding: CGFloat
    private let titleHeight: CGFloat
    private let cols: Int
    private var panelViews: [NSView] = []
    private var skViews: [SKView] = []

    init(presets: [DemoPreset], padding: CGFloat, titleHeight: CGFloat, cols: Int) {
        self.presets = presets
        self.padding = padding
        self.titleHeight = titleHeight
        self.cols = cols
        super.init(frame: .zero)
        wantsLayer = true
        setupPanels()
    }

    @available(*, unavailable)
    required init?(coder: NSCoder) { fatalError() }

    private func setupPanels() {
        for preset in presets {
            // Container for each panel
            let panel = NSView()
            panel.wantsLayer = true
            panel.layer?.backgroundColor = NSColor(red: 0.1, green: 0.1, blue: 0.18, alpha: 1.0).cgColor
            panel.layer?.cornerRadius = 8

            // SKView
            let skView = SKView()
            skView.allowsTransparency = true
            skView.wantsLayer = true
            panel.addSubview(skView)

            // Title label
            let label = NSTextField(labelWithString: preset.title)
            label.font = NSFont.systemFont(ofSize: 13, weight: .medium)
            label.textColor = NSColor.white.withAlphaComponent(0.85)
            label.alignment = .center
            panel.addSubview(label)

            addSubview(panel)
            panelViews.append(panel)
            skViews.append(skView)
        }
    }

    override func layout() {
        super.layout()

        let totalWidth = bounds.width
        let totalHeight = bounds.height

        let topRowCount = cols       // 4
        let bottomRowCount = presets.count - cols  // 3

        let cellWidth = (totalWidth - padding * CGFloat(topRowCount + 1)) / CGFloat(topRowCount)
        let cellHeight = (totalHeight - padding * 3) / 2.0  // 2 rows + 3 paddings (top, middle, bottom)

        // Top row: 4 panels
        for i in 0..<topRowCount {
            let x = padding + CGFloat(i) * (cellWidth + padding)
            let y = totalHeight - padding - cellHeight
            layoutPanel(index: i, frame: NSRect(x: x, y: y, width: cellWidth, height: cellHeight))
        }

        // Bottom row: 3 panels, centered
        let bottomTotalWidth = CGFloat(bottomRowCount) * cellWidth + CGFloat(bottomRowCount - 1) * padding
        let bottomStartX = (totalWidth - bottomTotalWidth) / 2
        for j in 0..<bottomRowCount {
            let i = topRowCount + j
            let x = bottomStartX + CGFloat(j) * (cellWidth + padding)
            let y = padding
            layoutPanel(index: i, frame: NSRect(x: x, y: y, width: cellWidth, height: cellHeight))
        }
    }

    private func layoutPanel(index: Int, frame: NSRect) {
        let panel = panelViews[index]
        panel.frame = frame

        let skView = skViews[index]
        let skFrame = NSRect(x: 0, y: titleHeight, width: frame.width, height: frame.height - titleHeight)
        skView.frame = skFrame

        // Present scene if not already presented (or if size changed significantly)
        if skView.scene == nil || abs(skView.scene!.size.width - skFrame.width) > 1 {
            let config = presets[index].config
            let scene = ParticleScene(size: skFrame.size, config: config)
            scene.scaleMode = .resizeFill
            skView.presentScene(scene)
        }

        // Title label is the second subview
        if let label = panel.subviews.last as? NSTextField {
            label.frame = NSRect(x: 0, y: 2, width: frame.width, height: titleHeight - 2)
        }
    }
}
```

---

### Task 7: Create main.swift entry point

**Files:**
- Create: `Demo/Sources/main.swift`

**Step 1: Write main.swift**

```swift
import AppKit

let app = NSApplication.shared
app.setActivationPolicy(.regular)  // Normal app with Dock icon

let delegate = DemoAppDelegate()
app.delegate = delegate
app.run()
```

---

### Task 8: Build and test

**Step 1: Build the Demo app**

Run: `cd /Users/yfr-mac-studio/GitHub/jianminhuang/confetti/Demo && swift build`
Expected: Build succeeds

**Step 2: Run the Demo app**

Run: `cd /Users/yfr-mac-studio/GitHub/jianminhuang/confetti/Demo && swift run ConfettiDemo`
Expected: Window appears with 7 panels, each running its preset effect in a loop

**Step 3: Verify**
- All 7 effects render correctly
- Effects loop (restart after duration ends)
- Window is resizable and panels scale proportionally
- Title labels are visible below each panel
- Bottom row of 3 is centered

---

### Task 9: Commit

**Step 1: Commit the Demo app**

```bash
git add Demo/
git commit -m "feat: add Demo app with 7-panel effect showcase"
```
